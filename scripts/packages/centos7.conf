# CentOS 7 system package configuration
# Applicable to: CentOS 7 (centos/7)

# Check if sudo is needed (usually runs as root in Docker containers)
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

# CentOS 7 uses yum
PKG_MANAGER="yum"
PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} yum check-update || true"
PKG_INSTALL_CMD="${SUDO_CMD} yum install -y"

# CentOS 7 镜像源已过期（EOL），需要更新
# 使用阿里云镜像作为基础仓库，vault.centos.org 作为 SCL 仓库
MIRROR_SETUP_COMMANDS=(
    # 更新基础仓库到阿里云镜像（速度更快）
    "${SUDO_CMD} sed -i -e 's|mirrorlist=|#mirrorlist=|g' -e 's|#baseurl=http://mirror.centos.org|baseurl=https://mirrors.aliyun.com|g' /etc/yum.repos.d/CentOS-*.repo"
    # 清理缓存
    "${SUDO_CMD} yum clean all"
    "${SUDO_CMD} yum makecache"
    # 安装 EPEL 和 SCL 仓库
    "${SUDO_CMD} yum install -y epel-release centos-release-scl centos-release-scl-rh"
    # 配置 SCL 仓库为 vault.centos.org（阿里云没有 SCL 镜像）
    "${SUDO_CMD} bash -c 'cat > /etc/yum.repos.d/CentOS-SCLo-scl.repo <<EOF
[centos-sclo-sclo]
name=CentOS-7 - SCLo sclo
baseurl=http://vault.centos.org/7.9.2009/sclo/\\\$basearch/sclo/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo
EOF'"
    "${SUDO_CMD} bash -c 'cat > /etc/yum.repos.d/CentOS-SCLo-scl-rh.repo <<EOF
[centos-sclo-rh]
name=CentOS-7 - SCLo rh
baseurl=http://vault.centos.org/7.9.2009/sclo/\\\$basearch/rh/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo
EOF'"
    # 重新生成缓存
    "${SUDO_CMD} yum clean all"
    "${SUDO_CMD} yum makecache fast"
)

# List of packages to install
PACKAGES=(
    # Build tools
    "automake"
    "bison"
    "bzip2"
    "ca-certificates"
    "curl"
    "diffutils"
    "file"
    "flex"
    "gawk"
    "gdb"
    "git"
    "gperf"
    "help2man"
    "ncurses-devel"
    "openssl-devel"
    "libtool"
    "make"
    "patch"
    "pkgconfig"
    "python3"
    "python3-pip"
    "rsync"
    "texinfo"
    "unzip"
    "wget"
    "which"
    "xz"
    # CentOS 7 specific: devtoolset-11 for modern GCC with C++20 support (required by mold)
    "devtoolset-11-gcc"
    "devtoolset-11-gcc-c++"
    "devtoolset-11-binutils"
    "libstdc++-static"
)

# CMake version requirement
# mold's mimalloc dependency requires CMake 3.18+
# CentOS 7's cmake is too old, we will install via pip3
USE_PIP_CMAKE=true

# CentOS 7 uses devtoolset-10 for modern GCC
USE_DEVTOOLSET=true

# System-specific additional configuration commands (optional)
EXTRA_SETUP_COMMANDS=()

# Enable devtoolset-11 by default
# crosstool-ng prohibits setting LD_LIBRARY_PATH, so we CANNOT use 'source /opt/rh/devtoolset-11/enable'
# Instead, we create symbolic links to make devtoolset-11 gcc the default
if [ "$USE_DEVTOOLSET" = true ]; then
    EXTRA_SETUP_COMMANDS+=(
        # Create symbolic links to make devtoolset-11 gcc the default
        "${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/gcc /usr/local/bin/gcc"
        "${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/g++ /usr/local/bin/g++"
        "${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/c++ /usr/local/bin/c++"
        "${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/cpp /usr/local/bin/cpp"
        # Ensure /usr/local/bin is in PATH (before /usr/bin)
        "export PATH=/usr/local/bin:\$PATH"
    )
fi

# Install the latest CMake (4.0+) via pip3
# mold's mimalloc dependency requires CMake 3.18+
EXTRA_SETUP_COMMANDS+=(
    # Upgrade pip first
    "${SUDO_CMD} python3 -m pip install --upgrade pip"
    # Install the latest CMake via pip3
    "${SUDO_CMD} python3 -m pip install cmake"
    # Ensure pip-installed cmake is in PATH
    "export PATH=/usr/local/bin:\$PATH"
)

