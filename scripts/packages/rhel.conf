# RHEL/CentOS/Fedora system package configuration (generic version)
# Applicable to: RHEL, CentOS, Fedora, Rocky Linux, AlmaLinux
# Note: Amazon Linux 2 and Alibaba Cloud Linux 3 have dedicated configuration files

# Check if sudo is needed (usually runs as root in Docker containers)
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

# Detect whether to use yum or dnf
if command -v dnf &> /dev/null; then
    PKG_MANAGER="dnf"
    PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} dnf check-update || true"
    PKG_INSTALL_CMD="${SUDO_CMD} dnf install -y"
else
    PKG_MANAGER="yum"
    PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} yum check-update || true"
    PKG_INSTALL_CMD="${SUDO_CMD} yum install -y"
fi

# List of packages to install
PACKAGES=(
    # Build tools
    "automake"
    "bison"
    "bzip2"
    "ca-certificates"
    "curl"
    "diffutils"
    "file"
    "flex"
    "gawk"
    "gdb"
    "git"
    "gperf"
    "help2man"
    "ncurses-devel"
    "openssl-devel"
    "libtool"
    "make"
    "patch"
    "pkgconfig"
    "python3"
    "python3-pip"
    "rsync"
    "texinfo"
    "unzip"
    "wget"
    "which"
    "xz"
)

# CMake version requirement
# mold's mimalloc dependency requires CMake 3.18+
# Amazon Linux 2's cmake3 only has 3.17.5, which does not meet the requirement
# We will install the latest cmake via pip3
USE_PIP_CMAKE=false

# Detect and install appropriate GCC version
# Amazon Linux 2 and some RHEL systems provide gcc10, prefer to use it
USE_GCC10=false
# Add timeout mechanism to prevent yum/dnf commands from hanging
if timeout 30 bash -c "yum list available gcc10 &>/dev/null || dnf list available gcc10 &>/dev/null 2>/dev/null"; then
    PACKAGES+=("gcc10" "gcc10-c++" "libstdc++-static")
    USE_GCC10=true
else
    PACKAGES+=("gcc" "gcc-c++" "libstdc++-static")
fi

# System-specific additional configuration commands (optional)
EXTRA_SETUP_COMMANDS=()

# If gcc10 is installed, use the alternatives system to set it as the default compiler
# crosstool-ng prohibits setting the CC environment variable, so we use alternatives
if [ "$USE_GCC10" = true ]; then
    EXTRA_SETUP_COMMANDS+=(
        # Backup and remove old gcc executables, let alternatives take over
        "${SUDO_CMD} test -f /usr/bin/gcc && ! test -L /usr/bin/gcc && ${SUDO_CMD} mv /usr/bin/gcc /usr/bin/gcc.old || true"
        "${SUDO_CMD} test -f /usr/bin/g++ && ! test -L /usr/bin/g++ && ${SUDO_CMD} mv /usr/bin/g++ /usr/bin/g++.old || true"
        "${SUDO_CMD} test -f /usr/bin/c++ && ! test -L /usr/bin/c++ && ${SUDO_CMD} mv /usr/bin/c++ /usr/bin/c++.old || true"
        "${SUDO_CMD} test -f /usr/bin/cpp && ! test -L /usr/bin/cpp && ${SUDO_CMD} mv /usr/bin/cpp /usr/bin/cpp.old || true"
        # Configure gcc alternatives (priority 100)
        "${SUDO_CMD} alternatives --install /usr/bin/gcc gcc /usr/bin/gcc10-gcc 100"
        "${SUDO_CMD} alternatives --install /usr/bin/g++ g++ /usr/bin/gcc10-g++ 100"
        "${SUDO_CMD} alternatives --install /usr/bin/c++ c++ /usr/bin/gcc10-c++ 100"
        "${SUDO_CMD} alternatives --install /usr/bin/cpp cpp /usr/bin/gcc10-cpp 100"
        # Automatically select the highest priority version
        "${SUDO_CMD} alternatives --auto gcc"
        "${SUDO_CMD} alternatives --auto g++"
        "${SUDO_CMD} alternatives --auto c++"
        "${SUDO_CMD} alternatives --auto cpp"
    )
fi

# Install the latest CMake (4.0+) via pip3
# mold's mimalloc dependency requires CMake 3.18+
EXTRA_SETUP_COMMANDS+=(
    # Install the latest CMake via pip3
    "${SUDO_CMD} python3 -m pip install cmake"
    # Ensure pip-installed cmake is in PATH
    "export PATH=/usr/local/bin:\$PATH"
)

